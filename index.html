<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Timetable Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF.js Library -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sticky-col {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        /* Ensure sticky column has the right background */
        .sticky-col.day-header { background-color: #f3f4f6; }
        .sticky-col.day-cell { background-color: #f9fafb; }

        .sticky-header th {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #f3f4f6;
        }
        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">PDF Timetable Extractor</h1>
            <p class="text-lg text-gray-600 mt-2">Upload your 'Jadual Nama' PDF to automatically extract and display timetables.</p>
        </header>

        <!-- File Upload Section -->
        <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-md mb-12">
            <h2 class="text-xl font-semibold mb-4 text-center">Upload Timetable PDF</h2>
            <div class="flex items-center justify-center w-full">
                <label for="pdf-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-500">PDF file only</p>
                    </div>
                    <input id="pdf-upload" type="file" class="hidden" accept="application/pdf" />
                </label>
            </div>
             <p id="file-name" class="text-center text-sm text-gray-500 mt-2"></p>
        </div>

        <!-- Status/Loader -->
        <div id="status" class="text-center my-8 hidden">
             <div id="loader" class="mx-auto"></div>
             <p class="mt-4 text-gray-600">Processing PDF... This may take a moment.</p>
        </div>
       
        <!-- Results Container -->
        <div id="timetables-container" class="space-y-12">
             <!-- Timetables will be dynamically inserted here -->
        </div>

        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>Developed to automate timetable extraction.</p>
        </footer>
    </div>

    <script type="module">
        import * as pdfjsLib from "https://mozilla.github.io/pdf.js/build/pdf.mjs";

        // --- Configuration ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://mozilla.github.io/pdf.js/build/pdf.worker.mjs";
        
        const VALID_SUBJECTS = ["PH", "KOKO", "P", "IV", "MM", "PNG", "PI", "LET", "PM", "BC", "FIZ", "KKQ", "RB", "GE", "NILAM", "ASK", "IB", "PLC", "SN", "DBM", "KIM", "PD", "RBT", "TAW", "PPS", "BI", "MMT", "D", "na Insan", "BA", "SJ", "PJ", "REHAT"];
        const VALID_VENUES = ["M.KOM 1", "M.KOM 2", "M3", "MAK.BIO", "MAK.KIM", "M2", "BENGKEL E", "B. LUKISAN", "B. DIGITAL", "BENGKEL. P", "B.NILAM", "PAK 21 A", "BENGKEL R"];
        const DAY_ABBREVIATIONS = { "Mo": "Monday", "Tu": "Tuesday", "We": "Wednesday", "Th": "Thursday", "Fr": "Friday" };

        const fileInput = document.getElementById('pdf-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const statusDisplay = document.getElementById('status');
        const container = document.getElementById('timetables-container');

        fileInput.addEventListener('change', handleFileSelect);

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                alert("Please select a PDF file.");
                return;
            }

            fileNameDisplay.textContent = `File: ${file.name}`;
            statusDisplay.classList.remove('hidden');
            container.innerHTML = '';

            try {
                const pdfData = await readFile(file);
                const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                const teachersData = await parsePdfWithCoordinates(pdf);
                renderTimetables(teachersData);
            } catch (error) {
                console.error("Error processing PDF:", error);
                container.innerHTML = `<p class="text-center text-red-500 font-semibold">An error occurred while processing the PDF. It might be corrupted or in an unsupported format. Check the console for details.</p>`;
            } finally {
                statusDisplay.classList.add('hidden');
            }
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(new Uint8Array(e.target.result));
                reader.onerror = e => reject(new Error("File could not be read: " + e.target.error.code));
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function parsePdfWithCoordinates(pdf) {
            const allTeachers = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const items = content.items;

                let fullText = items.map(item => item.str).join(' ');
                const teacherNameMatch = fullText.match(/(?:NAMA GURU|Teacher)[:\s]+(.+?)(?=\s*SMK|Bermula|aSc|\s{4,})/i);
                if (!teacherNameMatch) continue;

                const teacher = {
                    name: teacherNameMatch[1].trim().replace(/\s*BIL\. \d+ \d{4}/, ''),
                    times: [],
                    schedule: {}
                };

                // Group items by line (y-coordinate)
                const lines = new Map();
                for (const item of items) {
                    const y = Math.round(item.transform[5]);
                    if (!lines.has(y)) lines.set(y, []);
                    lines.get(y).push(item);
                }
                
                // Find time slots and their x-coordinates
                let timeHeaderLineY = 0;
                let timeSlots = [];
                for (const [y, lineItems] of lines.entries()) {
                    const timeRegex = /^\d{1,2}:\d{2}$/;
                    const potentialTimes = lineItems.filter(item => timeRegex.test(item.str));
                    if (potentialTimes.length > 5) { // A reasonable number of time headers on one line
                         const sortedTimes = potentialTimes.sort((a, b) => a.transform[4] - b.transform[4]);
                         // Pair them up: 07:00-07:15, 07:15-07:45 etc.
                         for(let j = 0; j < sortedTimes.length -1; j++) {
                             timeSlots.push({
                                 text: `${sortedTimes[j].str}-${sortedTimes[j+1].str}`,
                                 x_start: sortedTimes[j].transform[4],
                                 x_end: sortedTimes[j+1].transform[4]
                             });
                         }
                         teacher.times = timeSlots.map(t => t.text);
                         break;
                    }
                }
                 if(timeSlots.length === 0) continue; // Skip page if no valid time headers

                // Find day rows and parse activities
                for (const [y, lineItems] of lines.entries()) {
                    const dayItem = lineItems.find(item => DAY_ABBREVIATIONS[item.str.trim()]);
                    if (dayItem) {
                        const dayName = DAY_ABBREVIATIONS[dayItem.str.trim()];
                        const dayActivities = Array(timeSlots.length).fill('');
                        
                        // Find all items on the same row as the day label
                        const activityItems = lineItems.filter(item => !DAY_ABBREVIATIONS[item.str.trim()]);
                        
                        for (const item of activityItems) {
                             const x = item.transform[4];
                             // Find which timeslot this item belongs to
                             for(let k = 0; k < timeSlots.length; k++) {
                                 if (x >= timeSlots[k].x_start -5 && x < timeSlots[k].x_end - 5) {
                                     dayActivities[k] += item.str + ' ';
                                     break;
                                 }
                             }
                        }
                        teacher.schedule[dayName] = dayActivities.map(act => act.trim());
                    }
                }
                allTeachers.push(teacher);
            }
            return allTeachers;
        }


        function parseCellContent(content) {
            const result = { subject: '', venue: '' };
            if (!content || typeof content !== 'string') return result;

            if (/\b(PN|EN|CIK|MISS|MR|UST|USTAZ|NAMA GURU|T[1-5])\b/i.test(content)) return result;

            let upperContent = content.toUpperCase();
            
            VALID_VENUES.forEach(v => {
                let searchVenue = v.replace(/\./g, '\\.');
                if (upperContent.includes(searchVenue)) {
                    result.venue = v;
                    upperContent = upperContent.replace(searchVenue, '');
                }
            });

            VALID_SUBJECTS.forEach(s => {
                if (new RegExp(`\\b${s}\\b`).test(upperContent)) {
                    if (!result.subject || s.length > result.subject.length) {
                        result.subject = s; // Prefer longer match if multiple e.g., "P" vs "PJ"
                    }
                }
            });
            
            if (upperContent.includes('REHAT')) {
                result.subject = 'REHAT';
                result.venue = '';
            }

            return result;
        }

        function renderTimetables(teachersData) {
            container.innerHTML = '';
            if (!teachersData || teachersData.length === 0) {
                container.innerHTML = `<p class="text-center text-red-500">Could not find any valid timetables in the PDF. The document structure might be different than expected.</p>`;
                return;
            }

            teachersData.forEach(teacher => {
                if (!teacher.name || Object.keys(teacher.schedule).length === 0) return;
                
                const teacherCard = document.createElement('div');
                teacherCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden';

                let tableHTML = `
                    <div class="p-4 sm:p-6 border-b border-gray-200 bg-gray-50">
                        <h2 class="text-xl sm:text-2xl font-bold text-indigo-700">${teacher.name}</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-100 sticky-header">
                                <tr>
                                    <th class="sticky-col day-header font-semibold p-3 text-gray-700 w-28">Day</th>
                                    ${teacher.times.map(time => `<th class="font-semibold p-3 text-gray-700 text-center min-w-[120px]">${time}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white">`;

                Object.values(DAY_ABBREVIATIONS).forEach(day => {
                    const activities = teacher.schedule[day] || Array(teacher.times.length).fill('');
                    tableHTML += `<tr class="border-t border-gray-200">`;
                    tableHTML += `<td class="sticky-col day-cell font-semibold p-3 text-gray-800">${day}</td>`;
                    
                    for(let i = 0; i < teacher.times.length; i++) {
                        const activity = activities[i] || '';
                        const { subject, venue } = parseCellContent(activity);
                        let cellContent = '';
                        let cellClass = 'h-16';

                        if (subject) {
                            cellContent = `<div class="font-semibold">${subject}</div>`;
                            if (venue) {
                                cellContent += `<div class="text-xs text-slate-600 mt-1">(${venue})</div>`;
                            }
                        }

                        if(subject && subject !== 'REHAT') cellClass += ' bg-indigo-50 text-indigo-800';
                        else if (subject === 'REHAT') cellClass += ' bg-green-50 text-green-700';
                        
                        tableHTML += `<td class="p-3 border-l border-gray-200 text-center ${cellClass}">${cellContent}</td>`;
                    }
                    tableHTML += `</tr>`;
                });

                tableHTML += `</tbody></table></div>`;
                teacherCard.innerHTML = tableHTML;
                container.appendChild(teacherCard);
            });
        }
    </script>

</body>
</html>